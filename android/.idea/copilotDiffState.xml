<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/AndroidManifest.xml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/AndroidManifest.xml" />
              <option name="originalContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&#10;    xmlns:tools=&quot;http://schemas.android.com/tools&quot;&gt;&#10;&#10;    &lt;!-- Hardware features --&gt;&#10;    &lt;uses-feature android:name=&quot;android.hardware.location.gps&quot; android:required=&quot;true&quot; /&gt;&#10;    &lt;uses-feature android:name=&quot;android.hardware.telephony&quot; android:required=&quot;false&quot; /&gt;&#10;&#10;    &lt;!-- Permissions for GPS tracking --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ACCESS_BACKGROUND_LOCATION&quot; /&gt;&#10;&#10;    &lt;!-- Permissions for phone and call management --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.READ_PHONE_STATE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.CALL_PHONE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ANSWER_PHONE_CALLS&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.READ_CALL_LOG&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.MANAGE_OWN_CALLS&quot; /&gt;&#10;&#10;    &lt;!-- Permissions for network and connectivity --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.CHANGE_NETWORK_STATE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ACCESS_WIFI_STATE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.CHANGE_WIFI_STATE&quot; /&gt;&#10;&#10;    &lt;!-- Permissions for device admin and kiosk mode --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.WRITE_SETTINGS&quot;&#10;        tools:ignore=&quot;ProtectedPermissions&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.WRITE_SECURE_SETTINGS&quot;&#10;        tools:ignore=&quot;ProtectedPermissions&quot; /&gt;&#10;&#10;    &lt;!-- Permissions for wakelock and foreground service --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.WAKE_LOCK&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE_LOCATION&quot; /&gt;&#10;&#10;    &lt;!-- Permission for battery stats --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.BATTERY_STATS&quot;&#10;        tools:ignore=&quot;ProtectedPermissions&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS&quot; /&gt;&#10;&#10;    &lt;!-- Permission for scheduling exact alarms --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.SCHEDULE_EXACT_ALARM&quot; /&gt;&#10;&#10;    &lt;!-- Permission for airplane mode --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.WRITE_APN_SETTINGS&quot;&#10;        tools:ignore=&quot;ProtectedPermissions&quot; /&gt;&#10;&#10;    &lt;application&#10;        android:allowBackup=&quot;true&quot;&#10;        android:testOnly=&quot;true&quot;&#10;        android:dataExtractionRules=&quot;@xml/data_extraction_rules&quot;&#10;        android:fullBackupContent=&quot;@xml/backup_rules&quot;&#10;        android:icon=&quot;@mipmap/ic_launcher&quot;&#10;        android:label=&quot;@string/app_name&quot;&#10;        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;&#10;        android:supportsRtl=&quot;true&quot;&#10;        android:theme=&quot;@style/Theme.GPSTracker&quot;&gt;&#10;&#10;        &lt;activity&#10;            android:name=&quot;.MainActivity&quot;&#10;            android:exported=&quot;true&quot;&#10;            android:label=&quot;@string/app_name&quot;&#10;            android:launchMode=&quot;singleTask&quot;&#10;            android:theme=&quot;@style/Theme.GPSTracker&quot;&gt;&#10;            &lt;intent-filter&gt;&#10;                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;&#10;                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;&#10;                &lt;category android:name=&quot;android.intent.category.HOME&quot; /&gt;&#10;                &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;&#10;            &lt;/intent-filter&gt;&#10;        &lt;/activity&gt;&#10;&#10;        &lt;!-- Device Admin Receiver for kiosk mode --&gt;&#10;        &lt;receiver&#10;            android:name=&quot;.admin.DeviceAdminReceiver&quot;&#10;            android:permission=&quot;android.permission.BIND_DEVICE_ADMIN&quot;&#10;            android:exported=&quot;true&quot;&gt;&#10;            &lt;meta-data&#10;                android:name=&quot;android.app.device_admin&quot;&#10;                android:resource=&quot;@xml/device_admin&quot; /&gt;&#10;            &lt;intent-filter&gt;&#10;                &lt;action android:name=&quot;android.app.action.DEVICE_ADMIN_ENABLED&quot; /&gt;&#10;            &lt;/intent-filter&gt;&#10;        &lt;/receiver&gt;&#10;&#10;        &lt;!-- Phone Call Receiver for call blocking and whitelisting --&gt;&#10;        &lt;receiver&#10;            android:name=&quot;.receiver.PhoneCallReceiver&quot;&#10;            android:exported=&quot;true&quot;&gt;&#10;            &lt;intent-filter&gt;&#10;                &lt;action android:name=&quot;android.intent.action.PHONE_STATE&quot; /&gt;&#10;            &lt;/intent-filter&gt;&#10;        &lt;/receiver&gt;&#10;&#10;        &lt;!-- Foreground Service for GPS tracking --&gt;&#10;        &lt;service&#10;            android:name=&quot;.service.GpsTrackingService&quot;&#10;            android:enabled=&quot;true&quot;&#10;            android:exported=&quot;false&quot;&#10;            android:foregroundServiceType=&quot;location&quot; /&gt;&#10;&#10;        &lt;service&#10;            android:name=&quot;.location.SinkholeVpnService&quot;&#10;            android:permission=&quot;android.permission.BIND_VPN_SERVICE&quot;&#10;            android:exported=&quot;true&quot;&gt;&#10;            &lt;intent-filter&gt;&#10;                &lt;action android:name=&quot;android.net.VpnService&quot; /&gt;&#10;            &lt;/intent-filter&gt;&#10;        &lt;/service&gt;&#10;    &lt;/application&gt;&#10;&#10;&#10;&lt;/manifest&gt;" />
              <option name="updatedContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&#10;    xmlns:tools=&quot;http://schemas.android.com/tools&quot;&gt;&#10;&#10;    &lt;!-- Hardware features --&gt;&#10;    &lt;uses-feature android:name=&quot;android.hardware.location.gps&quot; android:required=&quot;true&quot; /&gt;&#10;    &lt;uses-feature android:name=&quot;android.hardware.telephony&quot; android:required=&quot;false&quot; /&gt;&#10;&#10;    &lt;!-- Permissions for GPS tracking --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ACCESS_BACKGROUND_LOCATION&quot; /&gt;&#10;&#10;    &lt;!-- Permissions for phone and call management --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.READ_PHONE_STATE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.CALL_PHONE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ANSWER_PHONE_CALLS&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.READ_CALL_LOG&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.MANAGE_OWN_CALLS&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.VIBRATE&quot; /&gt;&#10;&#10;    &lt;!-- Permissions for network and connectivity --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.CHANGE_NETWORK_STATE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.ACCESS_WIFI_STATE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.CHANGE_WIFI_STATE&quot; /&gt;&#10;&#10;    &lt;!-- Permissions for device admin and kiosk mode --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.WRITE_SETTINGS&quot;&#10;        tools:ignore=&quot;ProtectedPermissions&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.WRITE_SECURE_SETTINGS&quot;&#10;        tools:ignore=&quot;ProtectedPermissions&quot; /&gt;&#10;&#10;    &lt;!-- Permissions for wakelock and foreground service --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.WAKE_LOCK&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE_LOCATION&quot; /&gt;&#10;&#10;    &lt;!-- Permission for battery stats --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.BATTERY_STATS&quot;&#10;        tools:ignore=&quot;ProtectedPermissions&quot; /&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS&quot; /&gt;&#10;&#10;    &lt;!-- Permission for scheduling exact alarms --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.SCHEDULE_EXACT_ALARM&quot; /&gt;&#10;&#10;    &lt;!-- Permission for airplane mode --&gt;&#10;    &lt;uses-permission android:name=&quot;android.permission.WRITE_APN_SETTINGS&quot;&#10;        tools:ignore=&quot;ProtectedPermissions&quot; /&gt;&#10;&#10;    &lt;application&#10;        android:allowBackup=&quot;true&quot;&#10;        android:testOnly=&quot;true&quot;&#10;        android:dataExtractionRules=&quot;@xml/data_extraction_rules&quot;&#10;        android:fullBackupContent=&quot;@xml/backup_rules&quot;&#10;        android:icon=&quot;@mipmap/ic_launcher&quot;&#10;        android:label=&quot;@string/app_name&quot;&#10;        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;&#10;        android:supportsRtl=&quot;true&quot;&#10;        android:theme=&quot;@style/Theme.GPSTracker&quot;&gt;&#10;&#10;        &lt;activity&#10;            android:name=&quot;.MainActivity&quot;&#10;            android:exported=&quot;true&quot;&#10;            android:label=&quot;@string/app_name&quot;&#10;            android:launchMode=&quot;singleTask&quot;&#10;            android:theme=&quot;@style/Theme.GPSTracker&quot;&gt;&#10;            &lt;intent-filter&gt;&#10;                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;&#10;                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;&#10;                &lt;category android:name=&quot;android.intent.category.HOME&quot; /&gt;&#10;                &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt;&#10;            &lt;/intent-filter&gt;&#10;        &lt;/activity&gt;&#10;&#10;        &lt;!-- Device Admin Receiver for kiosk mode --&gt;&#10;        &lt;receiver&#10;            android:name=&quot;.admin.DeviceAdminReceiver&quot;&#10;            android:permission=&quot;android.permission.BIND_DEVICE_ADMIN&quot;&#10;            android:exported=&quot;true&quot;&gt;&#10;            &lt;meta-data&#10;                android:name=&quot;android.app.device_admin&quot;&#10;                android:resource=&quot;@xml/device_admin&quot; /&gt;&#10;            &lt;intent-filter&gt;&#10;                &lt;action android:name=&quot;android.app.action.DEVICE_ADMIN_ENABLED&quot; /&gt;&#10;            &lt;/intent-filter&gt;&#10;        &lt;/receiver&gt;&#10;&#10;        &lt;!-- Phone Call Receiver for call blocking and whitelisting --&gt;&#10;        &lt;receiver&#10;            android:name=&quot;.receiver.PhoneCallReceiver&quot;&#10;            android:exported=&quot;true&quot;&gt;&#10;            &lt;intent-filter&gt;&#10;                &lt;action android:name=&quot;android.intent.action.PHONE_STATE&quot; /&gt;&#10;            &lt;/intent-filter&gt;&#10;        &lt;/receiver&gt;&#10;&#10;        &lt;!-- Foreground Service for GPS tracking --&gt;&#10;        &lt;service&#10;            android:name=&quot;.service.GpsTrackingService&quot;&#10;            android:enabled=&quot;true&quot;&#10;            android:exported=&quot;false&quot;&#10;            android:foregroundServiceType=&quot;location&quot; /&gt;&#10;&#10;        &lt;service&#10;            android:name=&quot;.location.SinkholeVpnService&quot;&#10;            android:permission=&quot;android.permission.BIND_VPN_SERVICE&quot;&#10;            android:exported=&quot;true&quot;&gt;&#10;            &lt;intent-filter&gt;&#10;                &lt;action android:name=&quot;android.net.VpnService&quot; /&gt;&#10;            &lt;/intent-filter&gt;&#10;        &lt;/service&gt;&#10;    &lt;/application&gt;&#10;&#10;&#10;&lt;/manifest&gt;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/ovh/tenjo/gpstracker/MainActivity.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/ovh/tenjo/gpstracker/MainActivity.kt" />
              <option name="originalContent" value="package ovh.tenjo.gpstracker&#10;&#10;import android.Manifest&#10;import android.app.ActivityManager&#10;import android.content.*&#10;import android.content.pm.PackageManager&#10;import android.net.VpnService&#10;import android.os.Build&#10;import android.os.Bundle&#10;import android.os.IBinder&#10;import android.util.Log&#10;import androidx.activity.ComponentActivity&#10;import androidx.activity.compose.setContent&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.rememberScrollState&#10;import androidx.compose.foundation.verticalScroll&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.unit.dp&#10;import androidx.core.content.ContextCompat&#10;import ovh.tenjo.gpstracker.config.AppConfig&#10;import ovh.tenjo.gpstracker.model.AppState&#10;import ovh.tenjo.gpstracker.service.GpsTrackingService&#10;import ovh.tenjo.gpstracker.ui.theme.GPSTrackerTheme&#10;import ovh.tenjo.gpstracker.location.SinkholeVpnService&#10;import ovh.tenjo.gpstracker.utils.VolumeControlManager&#10;import ovh.tenjo.gpstracker.utils.CallManager&#10;import java.text.SimpleDateFormat&#10;import java.util.*&#10;&#10;class MainActivity : ComponentActivity() {&#10;&#10;    private var trackingService: GpsTrackingService? = null&#10;    private var serviceBound = false&#10;&#10;    private lateinit var volumeControlManager: VolumeControlManager&#10;    lateinit var callManager: CallManager&#10;&#10;    private var stateInfo by mutableStateOf&lt;GpsTrackingService.StateInfo?&gt;(null)&#10;    private var isDeviceOwner by mutableStateOf(false)&#10;    var isIncomingCall by mutableStateOf(false)&#10;&#10;    private val serviceConnection = object : ServiceConnection {&#10;        override fun onServiceConnected(name: ComponentName?, service: IBinder?) {&#10;            val binder = service as GpsTrackingService.LocalBinder&#10;            trackingService = binder.getService()&#10;            serviceBound = true&#10;            updateStateInfo()&#10;        }&#10;&#10;        override fun onServiceDisconnected(name: ComponentName?) {&#10;            trackingService = null&#10;            serviceBound = false&#10;        }&#10;    }&#10;&#10;    private val stateUpdateReceiver = object : BroadcastReceiver() {&#10;        override fun onReceive(context: Context?, intent: Intent?) {&#10;            updateStateInfo()&#10;        }&#10;    }&#10;&#10;    private val callStateReceiver = object : BroadcastReceiver() {&#10;        override fun onReceive(context: Context?, intent: Intent?) {&#10;            when (intent?.action) {&#10;                ovh.tenjo.gpstracker.receiver.PhoneCallReceiver.ACTION_INCOMING_CALL -&gt; {&#10;                    isIncomingCall = true&#10;                    Log.d(TAG, &quot;UI: Incoming call detected - showing answer button&quot;)&#10;                }&#10;                ovh.tenjo.gpstracker.receiver.PhoneCallReceiver.ACTION_CALL_ENDED -&gt; {&#10;                    isIncomingCall = false&#10;                    Log.d(TAG, &quot;UI: Call ended - hiding answer button&quot;)&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    private val permissionLauncher = registerForActivityResult(&#10;        ActivityResultContracts.RequestMultiplePermissions()&#10;    ) { permissions -&gt;&#10;        val allGranted = permissions.values.all { it }&#10;        if (allGranted) {&#10;            startTrackingService()&#10;            startSinkholeVpn()&#10;        } else {&#10;            Log.e(TAG, &quot;Some permissions not granted&quot;)&#10;        }&#10;    }&#10;&#10;    private val vpnPermissionLauncher = registerForActivityResult(&#10;        ActivityResultContracts.StartActivityForResult()&#10;    ) { result -&gt;&#10;        if (result.resultCode == RESULT_OK) {&#10;            // VPN permission granted, start the service&#10;            startVpnServiceInternal()&#10;        } else {&#10;            // Permission not granted, show a message to the user&#10;            Log.e(TAG, &quot;VPN permission not granted&quot;)&#10;        }&#10;    }&#10;&#10;    override fun onCreate(savedInstanceState: Bundle?) {&#10;        super.onCreate(savedInstanceState)&#10;&#10;        // Initialize managers&#10;        volumeControlManager = VolumeControlManager(this)&#10;        callManager = CallManager(this)&#10;&#10;        // Check if device owner and apply volume controls&#10;        val devicePolicyManager = getSystemService(Context.DEVICE_POLICY_SERVICE) as android.app.admin.DevicePolicyManager&#10;        isDeviceOwner = devicePolicyManager.isDeviceOwnerApp(packageName)&#10;&#10;        if (isDeviceOwner) {&#10;            // Mute all volumes and disable volume buttons in DO mode&#10;            volumeControlManager.muteAllVolumes()&#10;            volumeControlManager.disableVolumeButtons()&#10;            Log.d(TAG, &quot;Device Owner mode: Volumes muted and buttons disabled&quot;)&#10;        }&#10;&#10;        // Request permissions&#10;        checkAndRequestPermissions()&#10;&#10;        // Register broadcast receiver&#10;        val filter = IntentFilter(GpsTrackingService.ACTION_STATE_UPDATE)&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {&#10;            registerReceiver(stateUpdateReceiver, filter, RECEIVER_NOT_EXPORTED)&#10;        } else {&#10;            @Suppress(&quot;UnspecifiedRegisterReceiverFlag&quot;)&#10;            registerReceiver(stateUpdateReceiver, filter)&#10;        }&#10;&#10;        // Register call state receiver&#10;        val callFilter = IntentFilter().apply {&#10;            addAction(ovh.tenjo.gpstracker.receiver.PhoneCallReceiver.ACTION_INCOMING_CALL)&#10;            addAction(ovh.tenjo.gpstracker.receiver.PhoneCallReceiver.ACTION_CALL_ENDED)&#10;        }&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {&#10;            registerReceiver(callStateReceiver, callFilter, RECEIVER_NOT_EXPORTED)&#10;        } else {&#10;            @Suppress(&quot;UnspecifiedRegisterReceiverFlag&quot;)&#10;            registerReceiver(callStateReceiver, callFilter)&#10;        }&#10;&#10;        setContent {&#10;            GPSTrackerTheme {&#10;                Surface(&#10;                    modifier = Modifier.fillMaxSize(),&#10;                    color = MaterialTheme.colorScheme.background&#10;                ) {&#10;                    DebugUI(stateInfo, this@MainActivity)&#10;                }&#10;            }&#10;        }&#10;&#10;        // Start lock task mode if device owner&#10;        try {&#10;            startLockTask()&#10;        } catch (e: Exception) {&#10;            Log.w(TAG, &quot;Could not start lock task mode&quot;, e)&#10;        }&#10;    }&#10;&#10;    override fun onStart() {&#10;        super.onStart()&#10;        // Bind to service&#10;        val intent = Intent(this, GpsTrackingService::class.java)&#10;        bindService(intent, serviceConnection, Context.BIND_AUTO_CREATE)&#10;    }&#10;&#10;    override fun onStop() {&#10;        super.onStop()&#10;        if (serviceBound) {&#10;            unbindService(serviceConnection)&#10;            serviceBound = false&#10;        }&#10;    }&#10;&#10;    override fun onDestroy() {&#10;        super.onDestroy()&#10;        try {&#10;            unregisterReceiver(stateUpdateReceiver)&#10;            unregisterReceiver(callStateReceiver)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error unregistering receiver&quot;, e)&#10;        }&#10;    }&#10;&#10;    private fun checkAndRequestPermissions() {&#10;        val permissions = mutableListOf(&#10;            Manifest.permission.ACCESS_FINE_LOCATION,&#10;            Manifest.permission.ACCESS_COARSE_LOCATION,&#10;            Manifest.permission.INTERNET,&#10;            Manifest.permission.ACCESS_NETWORK_STATE,&#10;            Manifest.permission.CHANGE_NETWORK_STATE,&#10;            Manifest.permission.ACCESS_WIFI_STATE,&#10;            Manifest.permission.CHANGE_WIFI_STATE,&#10;            Manifest.permission.READ_PHONE_STATE,&#10;            Manifest.permission.CALL_PHONE,&#10;            Manifest.permission.READ_CALL_LOG&#10;        )&#10;&#10;        // Add background location for Android 10+&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {&#10;            permissions.add(Manifest.permission.ACCESS_BACKGROUND_LOCATION)&#10;        }&#10;        &#10;        // Add foreground service location for Android 14+&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.UPSIDE_DOWN_CAKE) {&#10;            permissions.add(Manifest.permission.FOREGROUND_SERVICE_LOCATION)&#10;        }&#10;&#10;        // Add ANSWER_PHONE_CALLS for Android 8.0+&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {&#10;            permissions.add(Manifest.permission.ANSWER_PHONE_CALLS)&#10;        }&#10;&#10;        val permissionsToRequest = permissions.filter {&#10;            ContextCompat.checkSelfPermission(this, it) != PackageManager.PERMISSION_GRANTED&#10;        }&#10;&#10;        if (permissionsToRequest.isNotEmpty()) {&#10;            Log.d(TAG, &quot;Requesting permissions: $permissionsToRequest&quot;)&#10;            permissionLauncher.launch(permissionsToRequest.toTypedArray())&#10;        } else {&#10;            Log.d(TAG, &quot;All permissions already granted&quot;)&#10;            startTrackingService()&#10;            startSinkholeVpn()&#10;        }&#10;    }&#10;&#10;    private fun startTrackingService() {&#10;        if (!isServiceRunning(GpsTrackingService::class.java)) {&#10;            val intent = Intent(this, GpsTrackingService::class.java)&#10;            ContextCompat.startForegroundService(this, intent)&#10;            Log.d(TAG, &quot;Started tracking service&quot;)&#10;        }&#10;    }&#10;&#10;    private fun isServiceRunning(serviceClass: Class&lt;*&gt;): Boolean {&#10;        val manager = getSystemService(Context.ACTIVITY_SERVICE) as ActivityManager&#10;        @Suppress(&quot;DEPRECATION&quot;)&#10;        return manager.getRunningServices(Integer.MAX_VALUE)&#10;            .any { it.service.className == serviceClass.name }&#10;    }&#10;&#10;    private fun updateStateInfo() {&#10;        stateInfo = trackingService?.getStateInfo()&#10;    }&#10;&#10;    fun refreshInfo() {&#10;        updateStateInfo()&#10;    }&#10;&#10;    private fun startSinkholeVpn() {&#10;        try {&#10;            // Check if VPN permission is already granted&#10;            val prepareIntent = VpnService.prepare(this)&#10;            if (prepareIntent != null) {&#10;                // Need to request VPN permission (normal app mode)&#10;                Log.d(TAG, &quot;Requesting VPN permission via dialog&quot;)&#10;                try {&#10;                    vpnPermissionLauncher.launch(prepareIntent)&#10;                } catch (e: Exception) {&#10;                    Log.e(TAG, &quot;Failed to launch VPN permission dialog&quot;, e)&#10;                    startVpnServiceInternal()&#10;                }&#10;            } else {&#10;                // Permission already granted (Device Owner or previously authorized)&#10;                Log.d(TAG, &quot;VPN permission already granted&quot;)&#10;                startVpnServiceInternal()&#10;            }&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error starting VPN&quot;, e)&#10;        }&#10;    }&#10;&#10;    private fun startVpnServiceInternal() {&#10;        if (!isServiceRunning(SinkholeVpnService::class.java)) {&#10;            val intent = Intent(this, SinkholeVpnService::class.java)&#10;            try {&#10;                ContextCompat.startForegroundService(this, intent)&#10;                Log.d(TAG, &quot;Started Sinkhole VPN service&quot;)&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;Failed to start Sinkhole VPN service&quot;, e)&#10;            }&#10;        }&#10;    }&#10;&#10;    companion object {&#10;        private const val TAG = &quot;MainActivity&quot;&#10;    }&#10;}&#10;&#10;@Composable&#10;fun DebugUI(stateInfo: GpsTrackingService.StateInfo?, context: Context) {&#10;    val scrollState = rememberScrollState()&#10;    val mainActivity = context as? MainActivity&#10;&#10;    Column(&#10;        modifier = Modifier&#10;            .fillMaxSize()&#10;            .verticalScroll(scrollState)&#10;            .padding(16.dp)&#10;    ) {&#10;        // INCOMING CALL ANSWER BUTTON - Shows at top when call is ringing&#10;        if (mainActivity?.isIncomingCall == true) {&#10;            Card(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(vertical = 8.dp),&#10;                colors = CardDefaults.cardColors(&#10;                    containerColor = Color(0xFF4CAF50) // Green for answer&#10;                )&#10;            ) {&#10;                Column(&#10;                    modifier = Modifier.padding(16.dp),&#10;                    horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally&#10;                ) {&#10;                    Text(&#10;                        text = &quot; INCOMING CALL&quot;,&#10;                        style = MaterialTheme.typography.headlineSmall,&#10;                        color = Color.White&#10;                    )&#10;&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;&#10;                    Button(&#10;                        onClick = {&#10;                            mainActivity.callManager.acceptCall()&#10;                            Log.d(&quot;DebugUI&quot;, &quot;Answer button pressed&quot;)&#10;                        },&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .height(64.dp),&#10;                        colors = ButtonDefaults.buttonColors(&#10;                            containerColor = Color.White&#10;                        )&#10;                    ) {&#10;                        Text(&#10;                            text = &quot;ANSWER CALL&quot;,&#10;                            style = MaterialTheme.typography.titleLarge,&#10;                            color = Color(0xFF4CAF50)&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        Row(&#10;            modifier = Modifier.fillMaxWidth(),&#10;            horizontalArrangement = Arrangement.SpaceBetween&#10;        ) {&#10;            Text(&#10;                text = &quot;GPS Tracker Debug UI&quot;,&#10;                style = MaterialTheme.typography.headlineMedium,&#10;                modifier = Modifier.padding(bottom = 16.dp)&#10;            )&#10;&#10;            Button(&#10;                onClick = {&#10;                    (context as? MainActivity)?.refreshInfo()&#10;                },&#10;                modifier = Modifier.height(40.dp)&#10;            ) {&#10;                Text(&quot;Refresh&quot;)&#10;            }&#10;        }&#10;&#10;        // Current Time&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Current Time&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;                Text(&#10;                    text = SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.getDefault())&#10;                        .format(Date()),&#10;                    style = MaterialTheme.typography.bodyLarge&#10;                )&#10;            }&#10;        }&#10;&#10;        // App State&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Current State&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;&#10;                val stateColor = when (stateInfo?.state) {&#10;                    AppState.IDLE -&gt; Color.Gray&#10;                    AppState.AWAKE -&gt; Color.Green&#10;                    AppState.BATTERY_CHECK -&gt; Color.Yellow&#10;                    null -&gt; Color.Red&#10;                }&#10;&#10;                Box(&#10;                    modifier = Modifier&#10;                        .padding(top = 8.dp)&#10;                        .background(stateColor)&#10;                        .padding(8.dp)&#10;                ) {&#10;                    Text(&#10;                        text = stateInfo?.state?.name ?: &quot;UNKNOWN&quot;,&#10;                        style = MaterialTheme.typography.headlineSmall,&#10;                        color = Color.White&#10;                    )&#10;                }&#10;            }&#10;        }&#10;&#10;        // Location Status Card&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Location Status&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                Row(&#10;                    modifier = Modifier.padding(vertical = 4.dp),&#10;                    horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier&#10;                            .size(16.dp)&#10;                            .background(&#10;                                if (stateInfo?.locationStatus?.gpsEnabled == true) Color.Green else Color.Red&#10;                            )&#10;                    )&#10;                    Text(&#10;                        text = &quot;GPS Provider: ${if (stateInfo?.locationStatus?.gpsEnabled == true) &quot;Enabled&quot; else &quot;DISABLED&quot;}&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium&#10;                    )&#10;                }&#10;&#10;                Row(&#10;                    modifier = Modifier.padding(vertical = 4.dp),&#10;                    horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier&#10;                            .size(16.dp)&#10;                            .background(&#10;                                if (stateInfo?.locationStatus?.networkEnabled == true) Color.Green else Color.Gray&#10;                            )&#10;                    )&#10;                    Text(&#10;                        text = &quot;Network Provider: ${if (stateInfo?.locationStatus?.networkEnabled == true) &quot;Enabled&quot; else &quot;Disabled&quot;}&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium&#10;                    )&#10;                }&#10;&#10;                Row(&#10;                    modifier = Modifier.padding(vertical = 4.dp),&#10;                    horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier&#10;                            .size(16.dp)&#10;                            .background(&#10;                                if (stateInfo?.locationStatus?.isTracking == true) Color.Green else Color.Gray&#10;                            )&#10;                    )&#10;                    Text(&#10;                        text = &quot;Tracking Active: ${if (stateInfo?.locationStatus?.isTracking == true) &quot;Yes&quot; else &quot;No&quot;}&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium&#10;                    )&#10;                }&#10;&#10;                if (stateInfo?.locationStatus?.gpsEnabled == false) {&#10;                    Text(&#10;                        text = &quot;⚠️ GPS is disabled! Enable it in system settings.&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        color = MaterialTheme.colorScheme.error,&#10;                        modifier = Modifier.padding(top = 8.dp)&#10;                    )&#10;                }&#10;            }&#10;        }&#10;&#10;        // VPN Status Card&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Internet Sinkhole (VPN)&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                Row(&#10;                    modifier = Modifier.padding(vertical = 4.dp),&#10;                    horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier&#10;                            .size(16.dp)&#10;                            .background(&#10;                                if (stateInfo?.vpnStatus?.isActive == true) Color.Green else Color.Red&#10;                            )&#10;                    )&#10;                    Text(&#10;                        text = if (stateInfo?.vpnStatus?.isActive == true) &quot;Active - Blocking all other apps&quot; else &quot;Inactive&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium&#10;                    )&#10;                }&#10;&#10;                Text(&#10;                    text = &quot;Blocks all network traffic except this app&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = Color.Gray,&#10;                    modifier = Modifier.padding(top = 4.dp)&#10;                )&#10;&#10;                // Show blocked apps attempts&#10;                val blockedAttempts = stateInfo?.vpnStatus?.blockedAttempts ?: emptyList()&#10;                if (blockedAttempts.isNotEmpty()) {&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;                    Text(&#10;                        text = &quot;Blocked Network Attempts:&quot;,&#10;                        style = MaterialTheme.typography.titleSmall&#10;                    )&#10;&#10;                    blockedAttempts.take(5).forEach { attempt -&gt;&#10;                        val timeAgo = formatTimeAgo(attempt.lastAttemptTime)&#10;                        Text(&#10;                            text = &quot;• ${attempt.appName}: ${attempt.attemptCount} attempts ($timeAgo)&quot;,&#10;                            style = MaterialTheme.typography.bodySmall,&#10;                            modifier = Modifier.padding(start = 8.dp, top = 4.dp)&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        // Device Owner Status&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Device Owner Status&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;                Text(&#10;                    text = if (stateInfo?.isDeviceOwner == true) &quot;✓ Device Owner&quot; else &quot;✗ Not Device Owner&quot;,&#10;                    style = MaterialTheme.typography.bodyLarge,&#10;                    color = if (stateInfo?.isDeviceOwner == true) Color.Green else Color.Red&#10;                )&#10;&#10;                // Show hidden apps count if device owner&#10;                if (stateInfo?.isDeviceOwner == true) {&#10;                    Text(&#10;                        text = &quot;Hidden Apps: ${stateInfo.hiddenAppsCount}&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium,&#10;                        modifier = Modifier.padding(top = 4.dp)&#10;                    )&#10;                    Text(&#10;                        text = &quot;System Optimized for Battery&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        color = Color.Gray&#10;                    )&#10;                }&#10;            }&#10;        }&#10;&#10;        // Emergency Call Card - Call Mom or Dad&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp),&#10;            colors = CardDefaults.cardColors(&#10;                containerColor = MaterialTheme.colorScheme.primaryContainer&#10;            )&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Emergency Calls&quot;,&#10;                    style = MaterialTheme.typography.titleMedium,&#10;                    color = MaterialTheme.colorScheme.onPrimaryContainer&#10;                )&#10;&#10;                Text(&#10;                    text = &quot;Only calls from Mom or Dad are allowed&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = MaterialTheme.colorScheme.onPrimaryContainer,&#10;                    modifier = Modifier.padding(top = 4.dp, bottom = 12.dp)&#10;                )&#10;&#10;                Row(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    horizontalArrangement = Arrangement.spacedBy(12.dp)&#10;                ) {&#10;                    Button(&#10;                        onClick = {&#10;                            val mainActivity = context as? MainActivity&#10;                            mainActivity?.callManager?.callMom()&#10;                        },&#10;                        modifier = Modifier&#10;                            .weight(1f)&#10;                            .height(56.dp),&#10;                        colors = ButtonDefaults.buttonColors(&#10;                            containerColor = MaterialTheme.colorScheme.primary&#10;                        )&#10;                    ) {&#10;                        Column(&#10;                            horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally&#10;                        ) {&#10;                            Text(&#10;                                text = &quot;&quot;,&#10;                                style = MaterialTheme.typography.titleLarge&#10;                            )&#10;                            Text(&#10;                                text = &quot;Call Mom&quot;,&#10;                                style = MaterialTheme.typography.bodyMedium&#10;                            )&#10;                        }&#10;                    }&#10;&#10;                    Button(&#10;                        onClick = {&#10;                            val mainActivity = context as? MainActivity&#10;                            mainActivity?.callManager?.callDad()&#10;                        },&#10;                        modifier = Modifier&#10;                            .weight(1f)&#10;                            .height(56.dp),&#10;                        colors = ButtonDefaults.buttonColors(&#10;                            containerColor = MaterialTheme.colorScheme.primary&#10;                        )&#10;                    ) {&#10;                        Column(&#10;                            horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally&#10;                        ) {&#10;                            Text(&#10;                                text = &quot;&quot;,&#10;                                style = MaterialTheme.typography.titleLarge&#10;                            )&#10;                            Text(&#10;                                text = &quot;Call Dad&quot;,&#10;                                style = MaterialTheme.typography.bodyMedium&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;&#10;                Text(&#10;                    text = &quot;Mom: ${AppConfig.MOM_PHONE_NUMBER}\nDad: ${AppConfig.DAD_PHONE_NUMBER}&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = MaterialTheme.colorScheme.onPrimaryContainer,&#10;                    modifier = Modifier.padding(top = 12.dp)&#10;                )&#10;            }&#10;        }&#10;&#10;        // Battery Info&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Battery&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;                Text(&#10;                    text = &quot;Level: ${stateInfo?.batteryLevel ?: &quot;N/A&quot;}%&quot;,&#10;                    style = MaterialTheme.typography.bodyLarge&#10;                )&#10;                Text(&#10;                    text = &quot;Charging: ${if (stateInfo?.isCharging == true) &quot;Yes&quot; else &quot;No&quot;}&quot;,&#10;                    style = MaterialTheme.typography.bodyLarge&#10;                )&#10;            }&#10;        }&#10;&#10;        // HTTP Info (only show when awake)&#10;        if (stateInfo?.state == AppState.AWAKE) {&#10;            Card(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(vertical = 8.dp)&#10;            ) {&#10;                Column(modifier = Modifier.padding(16.dp)) {&#10;                    Text(&#10;                        text = &quot;HTTP API Connection&quot;,&#10;                        style = MaterialTheme.typography.titleMedium&#10;                    )&#10;&#10;                    Row(&#10;                        modifier = Modifier.padding(top = 8.dp),&#10;                        horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                    ) {&#10;                        Box(&#10;                            modifier = Modifier&#10;                                .size(16.dp)&#10;                                .background(&#10;                                    if (stateInfo?.httpConnected == true) Color.Green else Color.Red&#10;                                )&#10;                        )&#10;                        Text(&#10;                            text = if (stateInfo?.httpConnected == true) &quot;Ready&quot; else &quot;Not Ready&quot;,&#10;                            style = MaterialTheme.typography.bodyLarge&#10;                        )&#10;                    }&#10;&#10;                    Text(&#10;                        text = &quot;Endpoint: ${stateInfo?.apiEndpoint ?: &quot;N/A&quot;}&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        modifier = Modifier.padding(top = 4.dp)&#10;                    )&#10;                    Text(&#10;                        text = &quot;Device ID: ${stateInfo?.deviceId ?: &quot;N/A&quot;}&quot;,&#10;                        style = MaterialTheme.typography.bodySmall&#10;                    )&#10;                }&#10;            }&#10;&#10;            // GPS Tracking Info&#10;            Card(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(vertical = 8.dp)&#10;            ) {&#10;                Column(modifier = Modifier.padding(16.dp)) {&#10;                    Text(&#10;                        text = &quot;GPS Tracking&quot;,&#10;                        style = MaterialTheme.typography.titleMedium&#10;                    )&#10;&#10;                    Row(&#10;                        modifier = Modifier.padding(top = 8.dp),&#10;                        horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                    ) {&#10;                        Box(&#10;                            modifier = Modifier&#10;                                .size(16.dp)&#10;                                .background(&#10;                                    if (stateInfo?.gpsTracking == true) Color.Green else Color.Red&#10;                                )&#10;                        )&#10;                        Text(&#10;                            text = if (stateInfo?.gpsTracking == true) &quot;Active&quot; else &quot;Inactive&quot;,&#10;                            style = MaterialTheme.typography.bodyLarge&#10;                        )&#10;                    }&#10;&#10;                    Text(&#10;                        text = &quot;Update interval: ${AppConfig.GPS_UPDATE_INTERVAL_MS / 1000}s&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        modifier = Modifier.padding(top = 4.dp)&#10;                    )&#10;                }&#10;            }&#10;        }&#10;&#10;        // Error Log Card&#10;        val errorLog = stateInfo?.errorLog ?: emptyList()&#10;        if (errorLog.isNotEmpty()) {&#10;            Card(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(vertical = 8.dp),&#10;                colors = CardDefaults.cardColors(&#10;                    containerColor = MaterialTheme.colorScheme.errorContainer&#10;                )&#10;            ) {&#10;                Column(modifier = Modifier.padding(16.dp)) {&#10;                    Text(&#10;                        text = &quot;Recent Errors (${errorLog.size})&quot;,&#10;                        style = MaterialTheme.typography.titleMedium,&#10;                        color = MaterialTheme.colorScheme.onErrorContainer&#10;                    )&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    errorLog.take(10).forEach { error -&gt;&#10;                        val timeStr = SimpleDateFormat(&quot;HH:mm:ss&quot;, Locale.getDefault())&#10;                            .format(Date(error.timestamp))&#10;                        Text(&#10;                            text = &quot;[$timeStr] ${error.module}: ${error.message}&quot;,&#10;                            style = MaterialTheme.typography.bodySmall,&#10;                            color = MaterialTheme.colorScheme.onErrorContainer,&#10;                            modifier = Modifier.padding(vertical = 2.dp)&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        // Awake Time Slots&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Configured Awake Time Slots&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;&#10;                AppConfig.AWAKE_TIME_SLOTS.forEach { timeSlot -&gt;&#10;                    Text(&#10;                        text = &quot;• $timeSlot&quot;,&#10;                        style = MaterialTheme.typography.bodyLarge,&#10;                        modifier = Modifier.padding(top = 4.dp)&#10;                    )&#10;                }&#10;            }&#10;        }&#10;&#10;        // System Info&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;System Information&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;                Text(&#10;                    text = &quot;Battery check: Every ${AppConfig.BATTERY_CHECK_INTERVAL_MS / 60000} minutes&quot;,&#10;                    style = MaterialTheme.typography.bodySmall&#10;                )&#10;                Text(&#10;                    text = &quot;Battery threshold: ${AppConfig.BATTERY_LOW_THRESHOLD}%&quot;,&#10;                    style = MaterialTheme.typography.bodySmall&#10;                )&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;fun formatTimeAgo(timestamp: Long): String {&#10;    val diff = System.currentTimeMillis() - timestamp&#10;    return when {&#10;        diff &lt; 60000 -&gt; &quot;just now&quot;&#10;        diff &lt; 3600000 -&gt; &quot;${diff / 60000}m ago&quot;&#10;        diff &lt; 86400000 -&gt; &quot;${diff / 3600000}h ago&quot;&#10;        else -&gt; &quot;${diff / 86400000}d ago&quot;&#10;    }&#10;}" />
              <option name="updatedContent" value="package ovh.tenjo.gpstracker&#10;&#10;import android.Manifest&#10;import android.app.ActivityManager&#10;import android.content.*&#10;import android.content.pm.PackageManager&#10;import android.net.VpnService&#10;import android.os.Build&#10;import android.os.Bundle&#10;import android.os.IBinder&#10;import android.util.Log&#10;import androidx.activity.ComponentActivity&#10;import androidx.activity.compose.setContent&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.rememberScrollState&#10;import androidx.compose.foundation.verticalScroll&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.unit.dp&#10;import androidx.core.content.ContextCompat&#10;import ovh.tenjo.gpstracker.config.AppConfig&#10;import ovh.tenjo.gpstracker.model.AppState&#10;import ovh.tenjo.gpstracker.service.GpsTrackingService&#10;import ovh.tenjo.gpstracker.ui.theme.GPSTrackerTheme&#10;import ovh.tenjo.gpstracker.location.SinkholeVpnService&#10;import ovh.tenjo.gpstracker.utils.VolumeControlManager&#10;import ovh.tenjo.gpstracker.utils.CallManager&#10;import java.text.SimpleDateFormat&#10;import java.util.*&#10;&#10;class MainActivity : ComponentActivity() {&#10;&#10;    private var trackingService: GpsTrackingService? = null&#10;    private var serviceBound = false&#10;&#10;    private lateinit var volumeControlManager: VolumeControlManager&#10;    lateinit var callManager: CallManager&#10;&#10;    private var stateInfo by mutableStateOf&lt;GpsTrackingService.StateInfo?&gt;(null)&#10;    private var isDeviceOwner by mutableStateOf(false)&#10;    var isIncomingCall by mutableStateOf(false)&#10;    var showCallMomConfirmation by mutableStateOf(false)&#10;    var showCallDadConfirmation by mutableStateOf(false)&#10;&#10;    private val serviceConnection = object : ServiceConnection {&#10;        override fun onServiceConnected(name: ComponentName?, service: IBinder?) {&#10;            val binder = service as GpsTrackingService.LocalBinder&#10;            trackingService = binder.getService()&#10;            serviceBound = true&#10;            updateStateInfo()&#10;        }&#10;&#10;        override fun onServiceDisconnected(name: ComponentName?) {&#10;            trackingService = null&#10;            serviceBound = false&#10;        }&#10;    }&#10;&#10;    private val stateUpdateReceiver = object : BroadcastReceiver() {&#10;        override fun onReceive(context: Context?, intent: Intent?) {&#10;            updateStateInfo()&#10;        }&#10;    }&#10;&#10;    private val callStateReceiver = object : BroadcastReceiver() {&#10;        override fun onReceive(context: Context?, intent: Intent?) {&#10;            when (intent?.action) {&#10;                ovh.tenjo.gpstracker.receiver.PhoneCallReceiver.ACTION_INCOMING_CALL -&gt; {&#10;                    isIncomingCall = true&#10;                    Log.d(TAG, &quot;UI: Incoming call detected - showing answer button&quot;)&#10;                }&#10;                ovh.tenjo.gpstracker.receiver.PhoneCallReceiver.ACTION_CALL_ENDED -&gt; {&#10;                    isIncomingCall = false&#10;                    Log.d(TAG, &quot;UI: Call ended - hiding answer button&quot;)&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    private val permissionLauncher = registerForActivityResult(&#10;        ActivityResultContracts.RequestMultiplePermissions()&#10;    ) { permissions -&gt;&#10;        val allGranted = permissions.values.all { it }&#10;        if (allGranted) {&#10;            startTrackingService()&#10;            startSinkholeVpn()&#10;        } else {&#10;            Log.e(TAG, &quot;Some permissions not granted&quot;)&#10;        }&#10;    }&#10;&#10;    private val vpnPermissionLauncher = registerForActivityResult(&#10;        ActivityResultContracts.StartActivityForResult()&#10;    ) { result -&gt;&#10;        if (result.resultCode == RESULT_OK) {&#10;            // VPN permission granted, start the service&#10;            startVpnServiceInternal()&#10;        } else {&#10;            // Permission not granted, show a message to the user&#10;            Log.e(TAG, &quot;VPN permission not granted&quot;)&#10;        }&#10;    }&#10;&#10;    override fun onCreate(savedInstanceState: Bundle?) {&#10;        super.onCreate(savedInstanceState)&#10;&#10;        // Initialize managers&#10;        volumeControlManager = VolumeControlManager(this)&#10;        callManager = CallManager(this)&#10;&#10;        // Check if device owner and apply volume controls&#10;        val devicePolicyManager = getSystemService(Context.DEVICE_POLICY_SERVICE) as android.app.admin.DevicePolicyManager&#10;        isDeviceOwner = devicePolicyManager.isDeviceOwnerApp(packageName)&#10;&#10;        if (isDeviceOwner) {&#10;            // Mute all volumes and disable volume buttons in DO mode&#10;            volumeControlManager.muteAllVolumes()&#10;            volumeControlManager.disableVolumeButtons()&#10;            Log.d(TAG, &quot;Device Owner mode: Volumes muted and buttons disabled&quot;)&#10;        }&#10;&#10;        // Request permissions&#10;        checkAndRequestPermissions()&#10;&#10;        // Register broadcast receiver&#10;        val filter = IntentFilter(GpsTrackingService.ACTION_STATE_UPDATE)&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {&#10;            registerReceiver(stateUpdateReceiver, filter, RECEIVER_NOT_EXPORTED)&#10;        } else {&#10;            @Suppress(&quot;UnspecifiedRegisterReceiverFlag&quot;)&#10;            registerReceiver(stateUpdateReceiver, filter)&#10;        }&#10;&#10;        // Register call state receiver&#10;        val callFilter = IntentFilter().apply {&#10;            addAction(ovh.tenjo.gpstracker.receiver.PhoneCallReceiver.ACTION_INCOMING_CALL)&#10;            addAction(ovh.tenjo.gpstracker.receiver.PhoneCallReceiver.ACTION_CALL_ENDED)&#10;        }&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {&#10;            registerReceiver(callStateReceiver, callFilter, RECEIVER_NOT_EXPORTED)&#10;        } else {&#10;            @Suppress(&quot;UnspecifiedRegisterReceiverFlag&quot;)&#10;            registerReceiver(callStateReceiver, callFilter)&#10;        }&#10;&#10;        setContent {&#10;            GPSTrackerTheme {&#10;                Surface(&#10;                    modifier = Modifier.fillMaxSize(),&#10;                    color = MaterialTheme.colorScheme.background&#10;                ) {&#10;                    DebugUI(stateInfo, this@MainActivity)&#10;                }&#10;            }&#10;        }&#10;&#10;        // Start lock task mode if device owner&#10;        try {&#10;            startLockTask()&#10;        } catch (e: Exception) {&#10;            Log.w(TAG, &quot;Could not start lock task mode&quot;, e)&#10;        }&#10;    }&#10;&#10;    override fun onStart() {&#10;        super.onStart()&#10;        // Bind to service&#10;        val intent = Intent(this, GpsTrackingService::class.java)&#10;        bindService(intent, serviceConnection, Context.BIND_AUTO_CREATE)&#10;    }&#10;&#10;    override fun onStop() {&#10;        super.onStop()&#10;        if (serviceBound) {&#10;            unbindService(serviceConnection)&#10;            serviceBound = false&#10;        }&#10;    }&#10;&#10;    override fun onDestroy() {&#10;        super.onDestroy()&#10;        try {&#10;            unregisterReceiver(stateUpdateReceiver)&#10;            unregisterReceiver(callStateReceiver)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error unregistering receiver&quot;, e)&#10;        }&#10;    }&#10;&#10;    private fun checkAndRequestPermissions() {&#10;        val permissions = mutableListOf(&#10;            Manifest.permission.ACCESS_FINE_LOCATION,&#10;            Manifest.permission.ACCESS_COARSE_LOCATION,&#10;            Manifest.permission.INTERNET,&#10;            Manifest.permission.ACCESS_NETWORK_STATE,&#10;            Manifest.permission.CHANGE_NETWORK_STATE,&#10;            Manifest.permission.ACCESS_WIFI_STATE,&#10;            Manifest.permission.CHANGE_WIFI_STATE,&#10;            Manifest.permission.READ_PHONE_STATE,&#10;            Manifest.permission.CALL_PHONE,&#10;            Manifest.permission.READ_CALL_LOG&#10;        )&#10;&#10;        // Add background location for Android 10+&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {&#10;            permissions.add(Manifest.permission.ACCESS_BACKGROUND_LOCATION)&#10;        }&#10;        &#10;        // Add foreground service location for Android 14+&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.UPSIDE_DOWN_CAKE) {&#10;            permissions.add(Manifest.permission.FOREGROUND_SERVICE_LOCATION)&#10;        }&#10;&#10;        // Add ANSWER_PHONE_CALLS for Android 8.0+&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {&#10;            permissions.add(Manifest.permission.ANSWER_PHONE_CALLS)&#10;        }&#10;&#10;        val permissionsToRequest = permissions.filter {&#10;            ContextCompat.checkSelfPermission(this, it) != PackageManager.PERMISSION_GRANTED&#10;        }&#10;&#10;        if (permissionsToRequest.isNotEmpty()) {&#10;            Log.d(TAG, &quot;Requesting permissions: $permissionsToRequest&quot;)&#10;            permissionLauncher.launch(permissionsToRequest.toTypedArray())&#10;        } else {&#10;            Log.d(TAG, &quot;All permissions already granted&quot;)&#10;            startTrackingService()&#10;            startSinkholeVpn()&#10;        }&#10;    }&#10;&#10;    private fun startTrackingService() {&#10;        if (!isServiceRunning(GpsTrackingService::class.java)) {&#10;            val intent = Intent(this, GpsTrackingService::class.java)&#10;            ContextCompat.startForegroundService(this, intent)&#10;            Log.d(TAG, &quot;Started tracking service&quot;)&#10;        }&#10;    }&#10;&#10;    private fun isServiceRunning(serviceClass: Class&lt;*&gt;): Boolean {&#10;        val manager = getSystemService(Context.ACTIVITY_SERVICE) as ActivityManager&#10;        @Suppress(&quot;DEPRECATION&quot;)&#10;        return manager.getRunningServices(Integer.MAX_VALUE)&#10;            .any { it.service.className == serviceClass.name }&#10;    }&#10;&#10;    private fun updateStateInfo() {&#10;        stateInfo = trackingService?.getStateInfo()&#10;    }&#10;&#10;    fun refreshInfo() {&#10;        updateStateInfo()&#10;    }&#10;&#10;    private fun startSinkholeVpn() {&#10;        try {&#10;            // Check if VPN permission is already granted&#10;            val prepareIntent = VpnService.prepare(this)&#10;            if (prepareIntent != null) {&#10;                // Need to request VPN permission (normal app mode)&#10;                Log.d(TAG, &quot;Requesting VPN permission via dialog&quot;)&#10;                try {&#10;                    vpnPermissionLauncher.launch(prepareIntent)&#10;                } catch (e: Exception) {&#10;                    Log.e(TAG, &quot;Failed to launch VPN permission dialog&quot;, e)&#10;                    startVpnServiceInternal()&#10;                }&#10;            } else {&#10;                // Permission already granted (Device Owner or previously authorized)&#10;                Log.d(TAG, &quot;VPN permission already granted&quot;)&#10;                startVpnServiceInternal()&#10;            }&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error starting VPN&quot;, e)&#10;        }&#10;    }&#10;&#10;    private fun startVpnServiceInternal() {&#10;        if (!isServiceRunning(SinkholeVpnService::class.java)) {&#10;            val intent = Intent(this, SinkholeVpnService::class.java)&#10;            try {&#10;                ContextCompat.startForegroundService(this, intent)&#10;                Log.d(TAG, &quot;Started Sinkhole VPN service&quot;)&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;Failed to start Sinkhole VPN service&quot;, e)&#10;            }&#10;        }&#10;    }&#10;&#10;    companion object {&#10;        private const val TAG = &quot;MainActivity&quot;&#10;    }&#10;}&#10;&#10;@Composable&#10;fun DebugUI(stateInfo: GpsTrackingService.StateInfo?, context: Context) {&#10;    val scrollState = rememberScrollState()&#10;    val mainActivity = context as? MainActivity&#10;&#10;    Column(&#10;        modifier = Modifier&#10;            .fillMaxSize()&#10;            .verticalScroll(scrollState)&#10;            .padding(16.dp)&#10;    ) {&#10;        // INCOMING CALL ANSWER BUTTON - Shows at top when call is ringing&#10;        if (mainActivity?.isIncomingCall == true) {&#10;            Card(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(vertical = 8.dp),&#10;                colors = CardDefaults.cardColors(&#10;                    containerColor = Color(0xFF4CAF50) // Green for answer&#10;                )&#10;            ) {&#10;                Column(&#10;                    modifier = Modifier.padding(24.dp),&#10;                    horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally&#10;                ) {&#10;                    Text(&#10;                        text = &quot; INCOMING CALL&quot;,&#10;                        style = MaterialTheme.typography.headlineLarge,&#10;                        color = Color.White&#10;                    )&#10;                    &#10;                    Text(&#10;                        text = &quot;From Mom or Dad&quot;,&#10;                        style = MaterialTheme.typography.titleMedium,&#10;                        color = Color.White,&#10;                        modifier = Modifier.padding(top = 4.dp)&#10;                    )&#10;                    &#10;                    Spacer(modifier = Modifier.height(20.dp))&#10;                    &#10;                    Button(&#10;                        onClick = {&#10;                            mainActivity.callManager.acceptCall()&#10;                            Log.d(&quot;DebugUI&quot;, &quot;Answer button pressed&quot;)&#10;                        },&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .height(80.dp),&#10;                        colors = ButtonDefaults.buttonColors(&#10;                            containerColor = Color.White&#10;                        )&#10;                    ) {&#10;                        Column(&#10;                            horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally&#10;                        ) {&#10;                            Text(&#10;                                text = &quot;&quot;,&#10;                                style = MaterialTheme.typography.displaySmall&#10;                            )&#10;                            Text(&#10;                                text = &quot;ANSWER&quot;,&#10;                                style = MaterialTheme.typography.headlineMedium,&#10;                                color = Color(0xFF4CAF50)&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        Row(&#10;            modifier = Modifier.fillMaxWidth(),&#10;            horizontalArrangement = Arrangement.SpaceBetween&#10;        ) {&#10;            Text(&#10;                text = &quot;GPS Tracker Debug UI&quot;,&#10;                style = MaterialTheme.typography.headlineMedium,&#10;                modifier = Modifier.padding(bottom = 16.dp)&#10;            )&#10;&#10;            Button(&#10;                onClick = {&#10;                    (context as? MainActivity)?.refreshInfo()&#10;                },&#10;                modifier = Modifier.height(40.dp)&#10;            ) {&#10;                Text(&quot;Refresh&quot;)&#10;            }&#10;        }&#10;&#10;        // Current Time&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Current Time&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;                Text(&#10;                    text = SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;, Locale.getDefault())&#10;                        .format(Date()),&#10;                    style = MaterialTheme.typography.bodyLarge&#10;                )&#10;            }&#10;        }&#10;&#10;        // App State&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Current State&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;&#10;                val stateColor = when (stateInfo?.state) {&#10;                    AppState.IDLE -&gt; Color.Gray&#10;                    AppState.AWAKE -&gt; Color.Green&#10;                    AppState.BATTERY_CHECK -&gt; Color.Yellow&#10;                    null -&gt; Color.Red&#10;                }&#10;&#10;                Box(&#10;                    modifier = Modifier&#10;                        .padding(top = 8.dp)&#10;                        .background(stateColor)&#10;                        .padding(8.dp)&#10;                ) {&#10;                    Text(&#10;                        text = stateInfo?.state?.name ?: &quot;UNKNOWN&quot;,&#10;                        style = MaterialTheme.typography.headlineSmall,&#10;                        color = Color.White&#10;                    )&#10;                }&#10;            }&#10;        }&#10;&#10;        // Location Status Card&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Location Status&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                Row(&#10;                    modifier = Modifier.padding(vertical = 4.dp),&#10;                    horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier&#10;                            .size(16.dp)&#10;                            .background(&#10;                                if (stateInfo?.locationStatus?.gpsEnabled == true) Color.Green else Color.Red&#10;                            )&#10;                    )&#10;                    Text(&#10;                        text = &quot;GPS Provider: ${if (stateInfo?.locationStatus?.gpsEnabled == true) &quot;Enabled&quot; else &quot;DISABLED&quot;}&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium&#10;                    )&#10;                }&#10;&#10;                Row(&#10;                    modifier = Modifier.padding(vertical = 4.dp),&#10;                    horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier&#10;                            .size(16.dp)&#10;                            .background(&#10;                                if (stateInfo?.locationStatus?.networkEnabled == true) Color.Green else Color.Gray&#10;                            )&#10;                    )&#10;                    Text(&#10;                        text = &quot;Network Provider: ${if (stateInfo?.locationStatus?.networkEnabled == true) &quot;Enabled&quot; else &quot;Disabled&quot;}&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium&#10;                    )&#10;                }&#10;&#10;                Row(&#10;                    modifier = Modifier.padding(vertical = 4.dp),&#10;                    horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier&#10;                            .size(16.dp)&#10;                            .background(&#10;                                if (stateInfo?.locationStatus?.isTracking == true) Color.Green else Color.Gray&#10;                            )&#10;                    )&#10;                    Text(&#10;                        text = &quot;Tracking Active: ${if (stateInfo?.locationStatus?.isTracking == true) &quot;Yes&quot; else &quot;No&quot;}&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium&#10;                    )&#10;                }&#10;&#10;                if (stateInfo?.locationStatus?.gpsEnabled == false) {&#10;                    Text(&#10;                        text = &quot;⚠️ GPS is disabled! Enable it in system settings.&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        color = MaterialTheme.colorScheme.error,&#10;                        modifier = Modifier.padding(top = 8.dp)&#10;                    )&#10;                }&#10;            }&#10;        }&#10;&#10;        // VPN Status Card&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Internet Sinkhole (VPN)&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                Row(&#10;                    modifier = Modifier.padding(vertical = 4.dp),&#10;                    horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                ) {&#10;                    Box(&#10;                        modifier = Modifier&#10;                            .size(16.dp)&#10;                            .background(&#10;                                if (stateInfo?.vpnStatus?.isActive == true) Color.Green else Color.Red&#10;                            )&#10;                    )&#10;                    Text(&#10;                        text = if (stateInfo?.vpnStatus?.isActive == true) &quot;Active - Blocking all other apps&quot; else &quot;Inactive&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium&#10;                    )&#10;                }&#10;&#10;                Text(&#10;                    text = &quot;Blocks all network traffic except this app&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = Color.Gray,&#10;                    modifier = Modifier.padding(top = 4.dp)&#10;                )&#10;&#10;                // Show blocked apps attempts&#10;                val blockedAttempts = stateInfo?.vpnStatus?.blockedAttempts ?: emptyList()&#10;                if (blockedAttempts.isNotEmpty()) {&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;                    Text(&#10;                        text = &quot;Blocked Network Attempts:&quot;,&#10;                        style = MaterialTheme.typography.titleSmall&#10;                    )&#10;&#10;                    blockedAttempts.take(5).forEach { attempt -&gt;&#10;                        val timeAgo = formatTimeAgo(attempt.lastAttemptTime)&#10;                        Text(&#10;                            text = &quot;• ${attempt.appName}: ${attempt.attemptCount} attempts ($timeAgo)&quot;,&#10;                            style = MaterialTheme.typography.bodySmall,&#10;                            modifier = Modifier.padding(start = 8.dp, top = 4.dp)&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        // Device Owner Status&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Device Owner Status&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;                Text(&#10;                    text = if (stateInfo?.isDeviceOwner == true) &quot;✓ Device Owner&quot; else &quot;✗ Not Device Owner&quot;,&#10;                    style = MaterialTheme.typography.bodyLarge,&#10;                    color = if (stateInfo?.isDeviceOwner == true) Color.Green else Color.Red&#10;                )&#10;&#10;                // Show hidden apps count if device owner&#10;                if (stateInfo?.isDeviceOwner == true) {&#10;                    Text(&#10;                        text = &quot;Hidden Apps: ${stateInfo.hiddenAppsCount}&quot;,&#10;                        style = MaterialTheme.typography.bodyMedium,&#10;                        modifier = Modifier.padding(top = 4.dp)&#10;                    )&#10;                    Text(&#10;                        text = &quot;System Optimized for Battery&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        color = Color.Gray&#10;                    )&#10;                }&#10;            }&#10;        }&#10;&#10;        // Emergency Call Card - Call Mom or Dad&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp),&#10;            colors = CardDefaults.cardColors(&#10;                containerColor = MaterialTheme.colorScheme.primaryContainer&#10;            )&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Emergency Calls&quot;,&#10;                    style = MaterialTheme.typography.titleMedium,&#10;                    color = MaterialTheme.colorScheme.onPrimaryContainer&#10;                )&#10;&#10;                Text(&#10;                    text = &quot;Only calls from Mom or Dad are allowed&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = MaterialTheme.colorScheme.onPrimaryContainer,&#10;                    modifier = Modifier.padding(top = 4.dp, bottom = 12.dp)&#10;                )&#10;&#10;                Row(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    horizontalArrangement = Arrangement.spacedBy(12.dp)&#10;                ) {&#10;                    Button(&#10;                        onClick = {&#10;                            val mainActivity = context as? MainActivity&#10;                            mainActivity?.showCallMomConfirmation = true&#10;                        },&#10;                        modifier = Modifier&#10;                            .weight(1f)&#10;                            .height(56.dp),&#10;                        colors = ButtonDefaults.buttonColors(&#10;                            containerColor = MaterialTheme.colorScheme.primary&#10;                        )&#10;                    ) {&#10;                        Column(&#10;                            horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally&#10;                        ) {&#10;                            Text(&#10;                                text = &quot;&quot;,&#10;                                style = MaterialTheme.typography.titleLarge&#10;                            )&#10;                            Text(&#10;                                text = &quot;Call Mom&quot;,&#10;                                style = MaterialTheme.typography.bodyMedium&#10;                            )&#10;                        }&#10;                    }&#10;&#10;                    Button(&#10;                        onClick = {&#10;                            val mainActivity = context as? MainActivity&#10;                            mainActivity?.showCallDadConfirmation = true&#10;                        },&#10;                        modifier = Modifier&#10;                            .weight(1f)&#10;                            .height(56.dp),&#10;                        colors = ButtonDefaults.buttonColors(&#10;                            containerColor = MaterialTheme.colorScheme.primary&#10;                        )&#10;                    ) {&#10;                        Column(&#10;                            horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally&#10;                        ) {&#10;                            Text(&#10;                                text = &quot;&quot;,&#10;                                style = MaterialTheme.typography.titleLarge&#10;                            )&#10;                            Text(&#10;                                text = &quot;Call Dad&quot;,&#10;                                style = MaterialTheme.typography.bodyMedium&#10;                            )&#10;                        }&#10;                    }&#10;                }&#10;&#10;                Text(&#10;                    text = &quot;Mom: ${AppConfig.MOM_PHONE_NUMBER}\nDad: ${AppConfig.DAD_PHONE_NUMBER}&quot;,&#10;                    style = MaterialTheme.typography.bodySmall,&#10;                    color = MaterialTheme.colorScheme.onPrimaryContainer,&#10;                    modifier = Modifier.padding(top = 12.dp)&#10;                )&#10;            }&#10;        }&#10;&#10;        // Battery Info&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Battery&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;                Text(&#10;                    text = &quot;Level: ${stateInfo?.batteryLevel ?: &quot;N/A&quot;}%&quot;,&#10;                    style = MaterialTheme.typography.bodyLarge&#10;                )&#10;                Text(&#10;                    text = &quot;Charging: ${if (stateInfo?.isCharging == true) &quot;Yes&quot; else &quot;No&quot;}&quot;,&#10;                    style = MaterialTheme.typography.bodyLarge&#10;                )&#10;            }&#10;        }&#10;&#10;        // HTTP Info (only show when awake)&#10;        if (stateInfo?.state == AppState.AWAKE) {&#10;            Card(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(vertical = 8.dp)&#10;            ) {&#10;                Column(modifier = Modifier.padding(16.dp)) {&#10;                    Text(&#10;                        text = &quot;HTTP API Connection&quot;,&#10;                        style = MaterialTheme.typography.titleMedium&#10;                    )&#10;&#10;                    Row(&#10;                        modifier = Modifier.padding(top = 8.dp),&#10;                        horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                    ) {&#10;                        Box(&#10;                            modifier = Modifier&#10;                                .size(16.dp)&#10;                                .background(&#10;                                    if (stateInfo?.httpConnected == true) Color.Green else Color.Red&#10;                                )&#10;                        )&#10;                        Text(&#10;                            text = if (stateInfo?.httpConnected == true) &quot;Ready&quot; else &quot;Not Ready&quot;,&#10;                            style = MaterialTheme.typography.bodyLarge&#10;                        )&#10;                    }&#10;&#10;                    Text(&#10;                        text = &quot;Endpoint: ${stateInfo?.apiEndpoint ?: &quot;N/A&quot;}&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        modifier = Modifier.padding(top = 4.dp)&#10;                    )&#10;                    Text(&#10;                        text = &quot;Device ID: ${stateInfo?.deviceId ?: &quot;N/A&quot;}&quot;,&#10;                        style = MaterialTheme.typography.bodySmall&#10;                    )&#10;                }&#10;            }&#10;&#10;            // GPS Tracking Info&#10;            Card(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(vertical = 8.dp)&#10;            ) {&#10;                Column(modifier = Modifier.padding(16.dp)) {&#10;                    Text(&#10;                        text = &quot;GPS Tracking&quot;,&#10;                        style = MaterialTheme.typography.titleMedium&#10;                    )&#10;&#10;                    Row(&#10;                        modifier = Modifier.padding(top = 8.dp),&#10;                        horizontalArrangement = Arrangement.spacedBy(8.dp)&#10;                    ) {&#10;                        Box(&#10;                            modifier = Modifier&#10;                                .size(16.dp)&#10;                                .background(&#10;                                    if (stateInfo?.gpsTracking == true) Color.Green else Color.Red&#10;                                )&#10;                        )&#10;                        Text(&#10;                            text = if (stateInfo?.gpsTracking == true) &quot;Active&quot; else &quot;Inactive&quot;,&#10;                            style = MaterialTheme.typography.bodyLarge&#10;                        )&#10;                    }&#10;&#10;                    Text(&#10;                        text = &quot;Update interval: ${AppConfig.GPS_UPDATE_INTERVAL_MS / 1000}s&quot;,&#10;                        style = MaterialTheme.typography.bodySmall,&#10;                        modifier = Modifier.padding(top = 4.dp)&#10;                    )&#10;                }&#10;            }&#10;        }&#10;&#10;        // Error Log Card&#10;        val errorLog = stateInfo?.errorLog ?: emptyList()&#10;        if (errorLog.isNotEmpty()) {&#10;            Card(&#10;                modifier = Modifier&#10;                    .fillMaxWidth()&#10;                    .padding(vertical = 8.dp),&#10;                colors = CardDefaults.cardColors(&#10;                    containerColor = MaterialTheme.colorScheme.errorContainer&#10;                )&#10;            ) {&#10;                Column(modifier = Modifier.padding(16.dp)) {&#10;                    Text(&#10;                        text = &quot;Recent Errors (${errorLog.size})&quot;,&#10;                        style = MaterialTheme.typography.titleMedium,&#10;                        color = MaterialTheme.colorScheme.onErrorContainer&#10;                    )&#10;&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                    errorLog.take(10).forEach { error -&gt;&#10;                        val timeStr = SimpleDateFormat(&quot;HH:mm:ss&quot;, Locale.getDefault())&#10;                            .format(Date(error.timestamp))&#10;                        Text(&#10;                            text = &quot;[$timeStr] ${error.module}: ${error.message}&quot;,&#10;                            style = MaterialTheme.typography.bodySmall,&#10;                            color = MaterialTheme.colorScheme.onErrorContainer,&#10;                            modifier = Modifier.padding(vertical = 2.dp)&#10;                        )&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        // Awake Time Slots&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;Configured Awake Time Slots&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;&#10;                AppConfig.AWAKE_TIME_SLOTS.forEach { timeSlot -&gt;&#10;                    Text(&#10;                        text = &quot;• $timeSlot&quot;,&#10;                        style = MaterialTheme.typography.bodyLarge,&#10;                        modifier = Modifier.padding(top = 4.dp)&#10;                    )&#10;                }&#10;            }&#10;        }&#10;&#10;        // System Info&#10;        Card(&#10;            modifier = Modifier&#10;                .fillMaxWidth()&#10;                .padding(vertical = 8.dp)&#10;        ) {&#10;            Column(modifier = Modifier.padding(16.dp)) {&#10;                Text(&#10;                    text = &quot;System Information&quot;,&#10;                    style = MaterialTheme.typography.titleMedium&#10;                )&#10;                Text(&#10;                    text = &quot;Battery check: Every ${AppConfig.BATTERY_CHECK_INTERVAL_MS / 60000} minutes&quot;,&#10;                    style = MaterialTheme.typography.bodySmall&#10;                )&#10;                Text(&#10;                    text = &quot;Battery threshold: ${AppConfig.BATTERY_LOW_THRESHOLD}%&quot;,&#10;                    style = MaterialTheme.typography.bodySmall&#10;                )&#10;            }&#10;        }&#10;    }&#10;    &#10;    // Confirmation Dialog for Call Mom&#10;    if (mainActivity?.showCallMomConfirmation == true) {&#10;        AlertDialog(&#10;            onDismissRequest = { mainActivity.showCallMomConfirmation = false },&#10;            title = {&#10;                Column(&#10;                    horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally,&#10;                    modifier = Modifier.fillMaxWidth()&#10;                ) {&#10;                    Text(&#10;                        text = &quot;&quot;,&#10;                        style = MaterialTheme.typography.displayLarge&#10;                    )&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;                    Text(&#10;                        text = &quot;Call Mom?&quot;,&#10;                        style = MaterialTheme.typography.headlineMedium&#10;                    )&#10;                }&#10;            },&#10;            text = {&#10;                Column(&#10;                    horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally,&#10;                    modifier = Modifier.fillMaxWidth()&#10;                ) {&#10;                    Text(&#10;                        text = &quot;You are about to call:&quot;,&#10;                        style = MaterialTheme.typography.bodyLarge&#10;                    )&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;                    Text(&#10;                        text = AppConfig.MOM_PHONE_NUMBER,&#10;                        style = MaterialTheme.typography.headlineSmall,&#10;                        color = MaterialTheme.colorScheme.primary&#10;                    )&#10;                }&#10;            },&#10;            confirmButton = {&#10;                Button(&#10;                    onClick = {&#10;                        mainActivity?.callManager?.callMom()&#10;                        mainActivity?.showCallMomConfirmation = false&#10;                    },&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(56.dp),&#10;                    colors = ButtonDefaults.buttonColors(&#10;                        containerColor = Color(0xFF4CAF50)&#10;                    )&#10;                ) {&#10;                    Text(&#10;                        text = &quot;YES, CALL MOM&quot;,&#10;                        style = MaterialTheme.typography.titleMedium&#10;                    )&#10;                }&#10;            },&#10;            dismissButton = {&#10;                OutlinedButton(&#10;                    onClick = { mainActivity?.showCallMomConfirmation = false },&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(56.dp)&#10;                ) {&#10;                    Text(&#10;                        text = &quot;Cancel&quot;,&#10;                        style = MaterialTheme.typography.titleMedium&#10;                    )&#10;                }&#10;            }&#10;        )&#10;    }&#10;    &#10;    // Confirmation Dialog for Call Dad&#10;    if (mainActivity?.showCallDadConfirmation == true) {&#10;        AlertDialog(&#10;            onDismissRequest = { mainActivity.showCallDadConfirmation = false },&#10;            title = {&#10;                Column(&#10;                    horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally,&#10;                    modifier = Modifier.fillMaxWidth()&#10;                ) {&#10;                    Text(&#10;                        text = &quot;&quot;,&#10;                        style = MaterialTheme.typography.displayLarge&#10;                    )&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;                    Text(&#10;                        text = &quot;Call Dad?&quot;,&#10;                        style = MaterialTheme.typography.headlineMedium&#10;                    )&#10;                }&#10;            },&#10;            text = {&#10;                Column(&#10;                    horizontalAlignment = androidx.compose.ui.Alignment.CenterHorizontally,&#10;                    modifier = Modifier.fillMaxWidth()&#10;                ) {&#10;                    Text(&#10;                        text = &quot;You are about to call:&quot;,&#10;                        style = MaterialTheme.typography.bodyLarge&#10;                    )&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;                    Text(&#10;                        text = AppConfig.DAD_PHONE_NUMBER,&#10;                        style = MaterialTheme.typography.headlineSmall,&#10;                        color = MaterialTheme.colorScheme.primary&#10;                    )&#10;                }&#10;            },&#10;            confirmButton = {&#10;                Button(&#10;                    onClick = {&#10;                        mainActivity?.callManager?.callDad()&#10;                        mainActivity?.showCallDadConfirmation = false&#10;                    },&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(56.dp),&#10;                    colors = ButtonDefaults.buttonColors(&#10;                        containerColor = Color(0xFF4CAF50)&#10;                    )&#10;                ) {&#10;                    Text(&#10;                        text = &quot;YES, CALL DAD&quot;,&#10;                        style = MaterialTheme.typography.titleMedium&#10;                    )&#10;                }&#10;            },&#10;            dismissButton = {&#10;                OutlinedButton(&#10;                    onClick = { mainActivity?.showCallDadConfirmation = false },&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .height(56.dp)&#10;                ) {&#10;                    Text(&#10;                        text = &quot;Cancel&quot;,&#10;                        style = MaterialTheme.typography.titleMedium&#10;                    )&#10;                }&#10;            }&#10;        )&#10;    }&#10;}&#10;&#10;fun formatTimeAgo(timestamp: Long): String {&#10;    val diff = System.currentTimeMillis() - timestamp&#10;    return when {&#10;        diff &lt; 60000 -&gt; &quot;just now&quot;&#10;        diff &lt; 3600000 -&gt; &quot;${diff / 60000}m ago&quot;&#10;        diff &lt; 86400000 -&gt; &quot;${diff / 3600000}h ago&quot;&#10;        else -&gt; &quot;${diff / 86400000}d ago&quot;&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/ovh/tenjo/gpstracker/utils/VolumeControlManager.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/ovh/tenjo/gpstracker/utils/VolumeControlManager.kt" />
              <option name="originalContent" value="package ovh.tenjo.gpstracker.utils&#10;&#10;import android.app.admin.DevicePolicyManager&#10;import android.content.ComponentName&#10;import android.content.Context&#10;import android.media.AudioManager&#10;import android.util.Log&#10;import ovh.tenjo.gpstracker.admin.DeviceAdminReceiver&#10;&#10;class VolumeControlManager(private val context: Context) {&#10;&#10;    private val audioManager = context.getSystemService(Context.AUDIO_SERVICE) as AudioManager&#10;    private val devicePolicyManager = context.getSystemService(Context.DEVICE_POLICY_SERVICE) as DevicePolicyManager&#10;    private val adminComponent = ComponentName(context, DeviceAdminReceiver::class.java)&#10;&#10;    private var originalVolumes = mutableMapOf&lt;Int, Int&gt;()&#10;    private var isVolumeMuted = false&#10;&#10;    /**&#10;     * Mute all volumes (notifications, sounds, media, ringer) when in DO mode&#10;     */&#10;    fun muteAllVolumes() {&#10;        if (isVolumeMuted) return&#10;&#10;        try {&#10;            // Save original volumes&#10;            originalVolumes[AudioManager.STREAM_MUSIC] = audioManager.getStreamVolume(AudioManager.STREAM_MUSIC)&#10;            originalVolumes[AudioManager.STREAM_RING] = audioManager.getStreamVolume(AudioManager.STREAM_RING)&#10;            originalVolumes[AudioManager.STREAM_NOTIFICATION] = audioManager.getStreamVolume(AudioManager.STREAM_NOTIFICATION)&#10;            originalVolumes[AudioManager.STREAM_ALARM] = audioManager.getStreamVolume(AudioManager.STREAM_ALARM)&#10;            originalVolumes[AudioManager.STREAM_SYSTEM] = audioManager.getStreamVolume(AudioManager.STREAM_SYSTEM)&#10;&#10;            // Mute all streams&#10;            audioManager.setStreamVolume(AudioManager.STREAM_MUSIC, 0, 0)&#10;            audioManager.setStreamVolume(AudioManager.STREAM_RING, 0, 0)&#10;            audioManager.setStreamVolume(AudioManager.STREAM_NOTIFICATION, 0, 0)&#10;            audioManager.setStreamVolume(AudioManager.STREAM_ALARM, 0, 0)&#10;            audioManager.setStreamVolume(AudioManager.STREAM_SYSTEM, 0, 0)&#10;&#10;            // Set ringer mode to silent&#10;            audioManager.ringerMode = AudioManager.RINGER_MODE_SILENT&#10;&#10;            isVolumeMuted = true&#10;            Log.d(TAG, &quot;All volumes muted&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error muting volumes&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Restore original volumes&#10;     */&#10;    fun restoreVolumes() {&#10;        if (!isVolumeMuted) return&#10;&#10;        try {&#10;            originalVolumes.forEach { (streamType, volume) -&gt;&#10;                audioManager.setStreamVolume(streamType, volume, 0)&#10;            }&#10;&#10;            audioManager.ringerMode = AudioManager.RINGER_MODE_NORMAL&#10;            isVolumeMuted = false&#10;            originalVolumes.clear()&#10;            Log.d(TAG, &quot;Volumes restored&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error restoring volumes&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Enable ringer for incoming calls from whitelisted numbers&#10;     */&#10;    fun enableRingerForCall() {&#10;        try {&#10;            // Temporarily restore ring volume&#10;            val maxVolume = audioManager.getStreamMaxVolume(AudioManager.STREAM_RING)&#10;            val mediumVolume = (maxVolume * 0.7).toInt()&#10;            audioManager.setStreamVolume(AudioManager.STREAM_RING, mediumVolume, 0)&#10;            audioManager.ringerMode = AudioManager.RINGER_MODE_NORMAL&#10;            Log.d(TAG, &quot;Ringer enabled for incoming call&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error enabling ringer&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Disable ringer after call&#10;     */&#10;    fun disableRingerAfterCall() {&#10;        try {&#10;            audioManager.setStreamVolume(AudioManager.STREAM_RING, 0, 0)&#10;            audioManager.ringerMode = AudioManager.RINGER_MODE_SILENT&#10;            Log.d(TAG, &quot;Ringer disabled after call&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error disabling ringer&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Disable volume buttons using Device Owner API&#10;     */&#10;    fun disableVolumeButtons() {&#10;        if (!isDeviceOwner()) {&#10;            Log.w(TAG, &quot;Not device owner, cannot disable volume buttons&quot;)&#10;            return&#10;        }&#10;&#10;        try {&#10;            // Disable volume adjustment&#10;            devicePolicyManager.setMasterVolumeMuted(adminComponent, true)&#10;            Log.d(TAG, &quot;Volume buttons disabled via Device Policy&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error disabling volume buttons&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Enable volume buttons&#10;     */&#10;    fun enableVolumeButtons() {&#10;        if (!isDeviceOwner()) {&#10;            return&#10;        }&#10;&#10;        try {&#10;            devicePolicyManager.setMasterVolumeMuted(adminComponent, false)&#10;            Log.d(TAG, &quot;Volume buttons enabled&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error enabling volume buttons&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Check if app is device owner&#10;     */&#10;    private fun isDeviceOwner(): Boolean {&#10;        return devicePolicyManager.isDeviceOwnerApp(context.packageName)&#10;    }&#10;&#10;    companion object {&#10;        private const val TAG = &quot;VolumeControlManager&quot;&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package ovh.tenjo.gpstracker.utils&#10;&#10;import android.app.admin.DevicePolicyManager&#10;import android.content.ComponentName&#10;import android.content.Context&#10;import android.media.AudioManager&#10;import android.os.Build&#10;import android.os.VibrationEffect&#10;import android.os.Vibrator&#10;import android.os.PowerManager&#10;import android.util.Log&#10;import ovh.tenjo.gpstracker.admin.DeviceAdminReceiver&#10;&#10;class VolumeControlManager(private val context: Context) {&#10;&#10;    private val audioManager = context.getSystemService(Context.AUDIO_SERVICE) as AudioManager&#10;    private val devicePolicyManager = context.getSystemService(Context.DEVICE_POLICY_SERVICE) as DevicePolicyManager&#10;    private val adminComponent = ComponentName(context, DeviceAdminReceiver::class.java)&#10;    private val vibrator = context.getSystemService(Context.VIBRATOR_SERVICE) as Vibrator&#10;    private val powerManager = context.getSystemService(Context.POWER_SERVICE) as PowerManager&#10;&#10;    private var originalVolumes = mutableMapOf&lt;Int, Int&gt;()&#10;    private var isVolumeMuted = false&#10;    private var wakeLock: PowerManager.WakeLock? = null&#10;&#10;    /**&#10;     * Mute all volumes (notifications, sounds, media, ringer) when in DO mode&#10;     */&#10;    fun muteAllVolumes() {&#10;        if (isVolumeMuted) return&#10;&#10;        try {&#10;            // Save original volumes&#10;            originalVolumes[AudioManager.STREAM_MUSIC] = audioManager.getStreamVolume(AudioManager.STREAM_MUSIC)&#10;            originalVolumes[AudioManager.STREAM_RING] = audioManager.getStreamVolume(AudioManager.STREAM_RING)&#10;            originalVolumes[AudioManager.STREAM_NOTIFICATION] = audioManager.getStreamVolume(AudioManager.STREAM_NOTIFICATION)&#10;            originalVolumes[AudioManager.STREAM_ALARM] = audioManager.getStreamVolume(AudioManager.STREAM_ALARM)&#10;            originalVolumes[AudioManager.STREAM_SYSTEM] = audioManager.getStreamVolume(AudioManager.STREAM_SYSTEM)&#10;&#10;            // Mute all streams&#10;            audioManager.setStreamVolume(AudioManager.STREAM_MUSIC, 0, 0)&#10;            audioManager.setStreamVolume(AudioManager.STREAM_RING, 0, 0)&#10;            audioManager.setStreamVolume(AudioManager.STREAM_NOTIFICATION, 0, 0)&#10;            audioManager.setStreamVolume(AudioManager.STREAM_ALARM, 0, 0)&#10;            audioManager.setStreamVolume(AudioManager.STREAM_SYSTEM, 0, 0)&#10;&#10;            // Set ringer mode to silent&#10;            audioManager.ringerMode = AudioManager.RINGER_MODE_SILENT&#10;&#10;            isVolumeMuted = true&#10;            Log.d(TAG, &quot;All volumes muted&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error muting volumes&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Restore original volumes&#10;     */&#10;    fun restoreVolumes() {&#10;        if (!isVolumeMuted) return&#10;&#10;        try {&#10;            originalVolumes.forEach { (streamType, volume) -&gt;&#10;                audioManager.setStreamVolume(streamType, volume, 0)&#10;            }&#10;&#10;            audioManager.ringerMode = AudioManager.RINGER_MODE_NORMAL&#10;            isVolumeMuted = false&#10;            originalVolumes.clear()&#10;            Log.d(TAG, &quot;Volumes restored&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error restoring volumes&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Enable ringer for incoming calls from whitelisted numbers&#10;     * Also enables vibration and wakes screen&#10;     */&#10;    fun enableRingerForCall() {&#10;        try {&#10;            // Restore ring volume to maximum for whitelisted calls&#10;            val maxVolume = audioManager.getStreamMaxVolume(AudioManager.STREAM_RING)&#10;            audioManager.setStreamVolume(AudioManager.STREAM_RING, maxVolume, AudioManager.FLAG_SHOW_UI)&#10;            audioManager.ringerMode = AudioManager.RINGER_MODE_NORMAL&#10;&#10;            // Enable vibration&#10;            startVibration()&#10;&#10;            // Wake up and turn on the screen&#10;            wakeUpScreen()&#10;&#10;            Log.d(TAG, &quot;Ringer, vibration, and screen enabled for incoming call&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error enabling ringer&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Start vibration pattern for incoming call&#10;     */&#10;    private fun startVibration() {&#10;        try {&#10;            if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {&#10;                // Vibration pattern: wait 500ms, vibrate 1000ms, wait 500ms, vibrate 1000ms&#10;                val timings = longArrayOf(500, 1000, 500, 1000)&#10;                val amplitudes = intArrayOf(0, 255, 0, 255)&#10;                val vibrationEffect = VibrationEffect.createWaveform(timings, amplitudes, 0) // 0 = repeat&#10;                vibrator.vibrate(vibrationEffect)&#10;            } else {&#10;                @Suppress(&quot;DEPRECATION&quot;)&#10;                val pattern = longArrayOf(500, 1000, 500, 1000)&#10;                @Suppress(&quot;DEPRECATION&quot;)&#10;                vibrator.vibrate(pattern, 0) // 0 = repeat&#10;            }&#10;            Log.d(TAG, &quot;Vibration started&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error starting vibration&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Stop vibration&#10;     */&#10;    private fun stopVibration() {&#10;        try {&#10;            vibrator.cancel()&#10;            Log.d(TAG, &quot;Vibration stopped&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error stopping vibration&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Wake up the screen and keep it on&#10;     */&#10;    private fun wakeUpScreen() {&#10;        try {&#10;            // Acquire wake lock to turn on screen&#10;            @Suppress(&quot;DEPRECATION&quot;)&#10;            wakeLock = powerManager.newWakeLock(&#10;                PowerManager.SCREEN_BRIGHT_WAKE_LOCK or&#10;                        PowerManager.ACQUIRE_CAUSES_WAKEUP or&#10;                        PowerManager.ON_AFTER_RELEASE,&#10;                &quot;GPSTracker:IncomingCallWakeLock&quot;&#10;            )&#10;            wakeLock?.acquire(60000) // Keep screen on for 60 seconds max&#10;            Log.d(TAG, &quot;Screen wake lock acquired&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error waking screen&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Release wake lock&#10;     */&#10;    private fun releaseWakeLock() {&#10;        try {&#10;            wakeLock?.let {&#10;                if (it.isHeld) {&#10;                    it.release()&#10;                    Log.d(TAG, &quot;Screen wake lock released&quot;)&#10;                }&#10;            }&#10;            wakeLock = null&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error releasing wake lock&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Disable ringer after call&#10;     */&#10;    fun disableRingerAfterCall() {&#10;        try {&#10;            audioManager.setStreamVolume(AudioManager.STREAM_RING, 0, 0)&#10;            audioManager.ringerMode = AudioManager.RINGER_MODE_SILENT&#10;&#10;            // Stop vibration&#10;            stopVibration()&#10;&#10;            // Release wake lock&#10;            releaseWakeLock()&#10;&#10;            Log.d(TAG, &quot;Ringer, vibration disabled and screen released after call&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error disabling ringer&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Disable volume buttons using Device Owner API&#10;     */&#10;    fun disableVolumeButtons() {&#10;        if (!isDeviceOwner()) {&#10;            Log.w(TAG, &quot;Not device owner, cannot disable volume buttons&quot;)&#10;            return&#10;        }&#10;&#10;        try {&#10;            // Disable volume adjustment&#10;            devicePolicyManager.setMasterVolumeMuted(adminComponent, true)&#10;            Log.d(TAG, &quot;Volume buttons disabled via Device Policy&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error disabling volume buttons&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Enable volume buttons&#10;     */&#10;    fun enableVolumeButtons() {&#10;        if (!isDeviceOwner()) {&#10;            return&#10;        }&#10;&#10;        try {&#10;            devicePolicyManager.setMasterVolumeMuted(adminComponent, false)&#10;            Log.d(TAG, &quot;Volume buttons enabled&quot;)&#10;        } catch (e: Exception) {&#10;            Log.e(TAG, &quot;Error enabling volume buttons&quot;, e)&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Check if app is device owner&#10;     */&#10;    private fun isDeviceOwner(): Boolean {&#10;        return devicePolicyManager.isDeviceOwnerApp(context.packageName)&#10;    }&#10;&#10;    companion object {&#10;        private const val TAG = &quot;VolumeControlManager&quot;&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>